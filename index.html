<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 ARGBé£æ‰‡æ§åˆ¶å™¨</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg t='1751222519626' class='icon' viewBox='0 0 1024 1024' version='1.1' xmlns='http://www.w3.org/2000/svg' p-id='1910' width='200' height='200'%3E%3Cpath d='M931.84 1024H92.16a92.16 92.16 0 0 1-92.16-92.16V92.16a92.16 92.16 0 0 1 92.16-92.16h839.68a92.16 92.16 0 0 1 92.16 92.16v839.68a92.16 92.16 0 0 1-92.16 92.16zM92.16 61.44a30.72 30.72 0 0 0-30.72 30.72v839.68a30.72 30.72 0 0 0 30.72 30.72h839.68a30.72 30.72 0 0 0 30.72-30.72V92.16a30.72 30.72 0 0 0-30.72-30.72z' fill='%23ccccff' p-id='1911'%3E%3C/path%3E%3Cpath d='M230.8096 305.2544c0-8.9088 0-17.7152 0.9216-26.5216l40.96 2.9696a309.3504 309.3504 0 0 0 0 44.6464c6.5536 66.048 48.64 149.8112 113.664 174.08l-14.1312 38.5024c-81.92-29.9008-132.3008-127.6928-140.3904-208.7936-0.7168-8.704-1.024-16.7936-1.024-24.8832zM637.6448 525.6192l14.5408-38.2976c62.464 23.8592 107.9296 79.9744 131.4816 162.4064v2.2528a378.88 378.88 0 0 1 3.6864 98.5088l-40.96-3.8912a343.1424 343.1424 0 0 0-3.072-86.7328c-19.5584-69.8368-55.3984-115.0976-105.6768-134.2464zM413.2864 385.2288a164.6592 164.6592 0 0 1 2.7648-30.1056c12.3904-96.8704 76.9024-151.2448 131.7888-187.8016l1.7408-1.024c10.24-5.4272 19.1488-10.24 27.8528-13.5168L593.92 190.464c-7.2704 3.072-15.0528 6.8608-23.6544 11.4688-70.3488 47.104-105.2672 96.1536-112.64 159.0272v1.4336a121.6512 121.6512 0 0 0-1.2288 38.6048l-40.96 5.12a158.9248 158.9248 0 0 1-2.1504-20.8896zM434.7904 835.1744a296.96 296.96 0 0 0 49.3568-31.3344c59.5968-59.904 84.992-116.5312 79.6672-178.2784l40.96-3.4816c6.4512 74.9568-22.9376 142.2336-92.16 211.5584l-1.7408 1.6384a354.2016 354.2016 0 0 1-57.2416 36.5568zM166.4 628.3264l23.9616-33.28a314.9824 314.9824 0 0 0 78.1312 40.96c61.952 17.6128 118.4768 9.5232 168.0384-24.064l22.9376 33.8944a235.52 235.52 0 0 1-202.8544 29.3888h-1.2288a355.328 355.328 0 0 1-88.9856-46.8992zM554.9056 374.0672c47.5136-34.304 121.6512-43.52 203.264-25.3952l2.3552 0.6144A362.496 362.496 0 0 1 860.16 403.3536l-24.9856 32.5632a317.44 317.44 0 0 0-87.1424-47.5136c-69.8368-15.2576-131.4816-8.3968-169.2672 18.8416z' fill='%23ccccff' p-id='1912'%3E%3C/path%3E%3Cpath d='M133.12 512a378.88 378.88 0 1 1 656.896 257.4336A378.88 378.88 0 0 1 133.12 512z m696.32 0a317.44 317.44 0 0 0-634.88 0 312.832 312.832 0 0 0 13.2096 90.8288 316.0064 316.0064 0 0 0 242.176 220.5696 318.2592 318.2592 0 0 0 295.0144-95.744A316.3136 316.3136 0 0 0 829.44 512z' fill='%23ccccff' p-id='1913'%3E%3C/path%3E%3Cpath d='M348.16 512a163.84 163.84 0 0 1 68.9152-133.12A163.84 163.84 0 0 1 675.84 504.32a64.2048 64.2048 0 0 1 0 7.68 163.84 163.84 0 0 1-327.68 8.9088l30.72-1.2288-30.72 0.9216V512z m266.24-1.1264v-3.1744A102.4 102.4 0 0 0 409.6 512v5.7344a101.5808 101.5808 0 0 0 52.9408 84.0704A103.3216 103.3216 0 0 0 512 614.4a102.4 102.4 0 0 0 102.4-103.5264z' fill='%23ccccff' p-id='1914'%3E%3C/path%3E%3Cpath d='M168.96 168.96m-40.96 0a40.96 40.96 0 1 0 81.92 0 40.96 40.96 0 1 0-81.92 0Z' fill='%23ccccff' p-id='1915'%3E%3C/path%3E%3Cpath d='M855.04 168.96m-40.96 0a40.96 40.96 0 1 0 81.92 0 40.96 40.96 0 1 0-81.92 0Z' fill='%23ccccff' p-id='1916'%3E%3C/path%3E%3Cpath d='M168.96 855.04m-40.96 0a40.96 40.96 0 1 0 81.92 0 40.96 40.96 0 1 0-81.92 0Z' fill='%23ccccff' p-id='1917'%3E%3C/path%3E%3Cpath d='M855.04 855.04m-40.96 0a40.96 40.96 0 1 0 81.92 0 40.96 40.96 0 1 0-81.92 0Z' fill='%23ccccff' p-id='1918'%3E%3C/path%3E%3C/svg%3E"
    />
    <style>
      :root {
        --theme-primary: #667eea;
        --theme-secondary: #764ba2;
        --danger-color: #dc3545;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        overflow: hidden;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          var(--theme-primary) 0%,
          var(--theme-secondary) 100%
        );
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(
          135deg,
          var(--theme-primary) 0%,
          var(--theme-secondary) 100%
        );
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }
      .main-content {
        padding: 30px;
      }
      .control-section {
        margin-bottom: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border-left: 5px solid var(--theme-primary);
      }
      .section-title {
        font-size: 1.5em;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .section-title::before {
        content: "";
        width: 4px;
        height: 25px;
        background: var(--theme-primary);
        border-radius: 2px;
      }

      /* --- æ¡Œé¢ç«¯é¡¶éƒ¨æ§åˆ¶è¡Œå¸ƒå±€ --- */
      .top-row-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }
      .connection-module,
      .schedule-module {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .connection-module .port-input-wrapper {
        display: flex;
        gap: 5px;
      }
      .connection-module .title,
      .schedule-module .title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1em;
      }
      .connection-module input,
      .schedule-module input[type="time"] {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }
      .connection-module input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
      }

      /* --- ä¸»ä½“å†…å®¹ç½‘æ ¼å¸ƒå±€ --- */
      .main-layout-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }
      .left-column,
      .right-column {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      .control-section:last-child {
        margin-bottom: 0;
      }
      .preset-colors {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 15px;
      }
      .preset-color {
        width: 80px;
        height: 80px;
        border-radius: 15px;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        font-size: 14px;
        text-align: center;
        padding: 5px;
      }
      .preset-color:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      .speed-control {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .speed-control label {
        font-weight: 600;
      }
      .speed-control input[type="range"] {
        width: 100%;
        -webkit-appearance: none;
        height: 8px;
        background: #ddd;
        border-radius: 5px;
        outline: none;
      }
      .speed-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--theme-primary);
        cursor: pointer;
      }
      .custom-color-input textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: "Courier New", Courier, monospace;
        resize: vertical;
        margin-bottom: 15px;
      }
      .custom-color-input p {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: -10px;
        margin-bottom: 15px;
      }
      .status {
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--theme-primary) 0%,
          var(--theme-secondary) 100%
        );
        color: white;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      .btn-danger {
        background-color: var(--danger-color);
        color: white;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
      #connectionStatus {
        width: 165px;
      }

      /* --- **æ ¸å¿ƒæ”¹åŠ¨**: è‡ªé€‚åº”å±å¹•çš„åª’ä½“æŸ¥è¯¢ --- */
      @media (max-width: 992px) {
        * {
          overflow: auto;
        }
        body {
          padding: 10px;
        }
        .main-content {
          padding: 15px;
        }
        .control-section {
          padding: 20px;
        }

        /* é¡¶éƒ¨æ§åˆ¶è¡Œå˜ä¸ºå‚ç›´å †å  */
        .top-row-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 25px;
        }

        /* è¿æ¥å’Œå®šæ—¶æ¨¡å—å†…éƒ¨ä¹Ÿå˜ä¸ºå‚ç›´å †å  */
        .connection-module,
        .schedule-module {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }
        .connection-module .title,
        .schedule-module .title {
          width: 100%;
          justify-content: center;
        } /* æ ‡é¢˜å±…ä¸­ */
        .connection-module > div,
        .schedule-module > div {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%;
        }
        .connection-module .port-input-wrapper {
          flex-grow: 1;
          gap: 0;
        }
        .connection-module .port-input-wrapper #portInput {
          width: 130px;
        }
        .schedule-module .time-inputs {
          display: flex;
          align-items: center;
          gap: 5px;
        }
        #toggleConnectionBtn {
          width: 100%;
        }

        /* ä¸»å¸ƒå±€å˜ä¸ºå•åˆ— */
        .main-layout-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¨ ESP32 ARGBæ§åˆ¶å™¨</h1>
        <p>è¿œç¨‹æ§åˆ¶æ‚¨çš„ARGBé£æ‰‡ï¼Œåˆ›é€ ç‚«é…·çš„ç¯å…‰æ•ˆæœ</p>
      </div>
      <div class="main-content">
        <!-- 1. **æ ¸å¿ƒæ”¹åŠ¨**: æ–°çš„HTMLç»“æ„ -->
        <div class="control-section top-row-controls">
          <div class="connection-module">
            <div class="title"><span>ğŸ”Œ</span> è¿æ¥ç«¯å£</div>
            <div class="port-input-wrapper">
              <input type="text" id="portInput" placeholder="ä¸²å£/è®¾å¤‡è·¯å¾„" />
              <div id="connectionStatus" class="status disconnected">
                âŒ æœªè¿æ¥
              </div>
            </div>
            <div class="actions">
              <button
                id="toggleConnectionBtn"
                class="btn btn-primary"
                onclick="toggleConnection()"
              >
                è¿æ¥
              </button>
            </div>
          </div>
          <div class="schedule-module">
            <div class="title"><span>ğŸ•’</span> å®šæ—¶å…³é—­</div>
            <div class="time-inputs">
              <input
                type="time"
                id="startTime"
                value="00:00"
                title="å…³é—­æ—¶æ®µå¼€å§‹æ—¶é—´"
              />
              <span>-</span>
              <input
                type="time"
                id="endTime"
                value="08:00"
                title="å…³é—­æ—¶æ®µç»“æŸæ—¶é—´"
              />
            </div>
            <button
              class="btn btn-primary"
              onclick="applySchedule()"
              title="åº”ç”¨å®šæ—¶è®¡åˆ’"
            >
              åº”ç”¨
            </button>
          </div>
        </div>

        <!-- 2. ä¸»ä½“åŒåˆ—å¸ƒå±€ (å†…å®¹ä¸å˜) -->
        <div class="main-layout-grid">
          <div class="left-column">
            <div class="control-section">
              <h2 class="section-title">ğŸŒˆ é¢„è®¾æ¸å˜</h2>
              <div class="preset-colors">
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #ff0000,
                      #ffff00,
                      #00ff00,
                      #0000ff,
                      #ff00ff
                    );
                  "
                  onclick="setGradientPreset('rainbow')"
                >
                  å½©è™¹
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #f72585,
                      #7209b7,
                      #4361ee,
                      #4cc9f0
                    );
                  "
                  onclick="setGradientPreset('synthwave')"
                >
                  èµ›åšæœ‹å…‹
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #ff0000,
                      #ff8800,
                      #ffff00
                    );
                  "
                  onclick="setGradientPreset('fire')"
                >
                  ç«ç„°
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #ff4500,
                      #ff0000,
                      #200000
                    );
                  "
                  onclick="setGradientPreset('lava')"
                >
                  ç†”å²©
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #00ff88,
                      #00ffff,
                      #8800ff
                    );
                  "
                  onclick="setGradientPreset('aurora')"
                >
                  æå…‰
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #add8e6,
                      #00ffff,
                      #f0ffff
                    );
                  "
                  onclick="setGradientPreset('ice')"
                >
                  å†°æ™¶
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #00ff7f,
                      #228b22,
                      #f0e68c
                    );
                  "
                  onclick="setGradientPreset('forest')"
                >
                  æ£®æ—
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #f8cdda,
                      #ffffff,
                      #84d2f6
                    );
                  "
                  onclick="setGradientPreset('cottonCandy')"
                >
                  æ£‰èŠ±ç³–
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #2d388a,
                      #00aeef,
                      #fdb913,
                      #f15a24
                    );
                  "
                  onclick="setGradientPreset('sunrise')"
                >
                  æ—¥å‡º
                </div>
                <div
                  class="preset-color"
                  style="
                    background: linear-gradient(
                      45deg,
                      #00ff00,
                      #008000,
                      #000000
                    );
                  "
                  onclick="setGradientPreset('matrix')"
                >
                  çŸ©é˜µ
                </div>
              </div>
            </div>
            <div class="control-section">
              <h2 class="section-title">ğŸ¨ é¢„è®¾å•è‰²</h2>
              <div class="preset-colors">
                <div
                  class="preset-color"
                  style="background: #ff0000"
                  onclick="setStaticPreset('#ff0000')"
                >
                  æ­£çº¢
                </div>
                <div
                  class="preset-color"
                  style="background: #00ff00"
                  onclick="setStaticPreset('#00ff00')"
                >
                  äº®ç»¿
                </div>
                <div
                  class="preset-color"
                  style="background: #0000ff"
                  onclick="setStaticPreset('#0000ff')"
                >
                  å®è“
                </div>
                <div
                  class="preset-color"
                  style="background: #ffff00"
                  onclick="setStaticPreset('#ffff00')"
                >
                  æŸ æª¬é»„
                </div>
                <div
                  class="preset-color"
                  style="background: #00ffff"
                  onclick="setStaticPreset('#00ffff')"
                >
                  é’è‰²
                </div>
                <div
                  class="preset-color"
                  style="background: #ff8c00"
                  onclick="setStaticPreset('#ff8c00')"
                >
                  æ©™è‰²
                </div>
                <div
                  class="preset-color"
                  style="background: #4b0082"
                  onclick="setStaticPreset('#4b0082')"
                >
                  é›è“
                </div>
                <div
                  class="preset-color"
                  style="background: #dc143c"
                  onclick="setStaticPreset('#dc143c')"
                >
                  çŒ©çº¢
                </div>
                <div
                  class="preset-color"
                  style="background: #ffffff"
                  onclick="setStaticPreset('#ffffff')"
                >
                  çº¯ç™½
                </div>
                <div
                  class="preset-color"
                  style="background: #000000"
                  onclick="turnOff()"
                >
                  å…³é—­
                </div>
              </div>
            </div>
          </div>
          <div class="right-column">
            <div class="control-section">
              <h2 class="section-title">âš¡ æ¸å˜é€Ÿåº¦</h2>
              <div class="speed-control">
                <label for="speedControl">é€Ÿåº¦è°ƒèŠ‚ (1=æ…¢, 10=å¿«)</label>
                <input
                  type="range"
                  id="speedControl"
                  min="1"
                  max="10"
                  value="10"
                />
                <span id="speedValue">10</span>
              </div>
            </div>
            <div class="control-section">
              <h2 class="section-title">âœï¸ è‡ªå®šä¹‰é¢œè‰²/æ¸å˜</h2>
              <div class="custom-color-input">
                <textarea
                  id="customColorInput"
                  placeholder="ç‚¹å‡»å·¦ä¾§é¢„è®¾æˆ–åœ¨æ­¤æ‰‹åŠ¨è¾“å…¥..."
                ></textarea>
                <p>
                  è¾“å…¥å•ä¸ªé¢œè‰²ä¸ºå•è‰²æ¨¡å¼ï¼Œè¾“å…¥å¤šä¸ª(ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”)ä¸ºæ¸å˜æ¨¡å¼ã€‚
                </p>
                <button class="btn btn-primary" onclick="applyCustomInput()">
                  åº”ç”¨è‡ªå®šä¹‰
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let connected = false;
      let lastGradientColors = [];
      const gradientPresets = {
        rainbow: [
          "#ff0000",
          "#ff7f00",
          "#ffff00",
          "#00ff00",
          "#0000ff",
          "#4b0082",
          "#9400d3",
          "#ff0000",
        ],
        synthwave: [
          "#f72585",
          "#7209b7",
          "#3a0ca3",
          "#4361ee",
          "#4cc9f0",
          "#f72585",
        ],
        fire: ["#ff0000", "#ff8800", "#ffff00", "#ff0000"],
        lava: ["#000000", "#FF4500", "#FF0000", "#200000", "#000000"],
        aurora: ["#00ff88", "#00ffff", "#8800ff", "#00ff88"],
        ice: ["#ADD8E6", "#00FFFF", "#F0FFFF", "#00FFFF", "#ADD8E6"],
        forest: ["#00FF7F", "#228B22", "#F0E68C", "#228B22", "#00FF7F"],
        cottonCandy: ["#f8cdda", "#ffffff", "#84d2f6", "#ffffff", "#f8cdda"],
        sunrise: ["#2d388a", "#00aeef", "#fdb913", "#f15a24", "#2d388a"],
        matrix: [
          "#00ff00",
          "#00c000",
          "#008000",
          "#004000",
          "#000000",
          "#004000",
          "#008000",
          "#00c000",
          "#00ff00",
        ],
      };

      function updateConnectionUI() {
        const portInput = document.getElementById("portInput");
        const toggleBtn = document.getElementById("toggleConnectionBtn");
        const statusDiv = document.getElementById("connectionStatus");
        if (connected) {
          const connectedPort = portInput.value;
          toggleBtn.textContent = "æ–­å¼€";
          toggleBtn.className = "btn btn-danger";
          portInput.disabled = true;
          statusDiv.className = "status connected";
          statusDiv.innerHTML = `âœ… ${connectedPort}`;
        } else {
          toggleBtn.textContent = "è¿æ¥";
          toggleBtn.className = "btn btn-primary";
          portInput.disabled = false;
          statusDiv.className = "status disconnected";
          statusDiv.innerHTML = "âŒ æœªè¿æ¥";
        }
      }
      function toggleConnection() {
        if (connected) disconnect();
        else connect();
      }
      async function connect() {
        const portName = document.getElementById("portInput").value.trim();
        if (!portName) {
          alert("è¯·è¾“å…¥ä¸²å£/è®¾å¤‡è·¯å¾„");
          return;
        }
        try {
          const resp = await fetch("/api/connect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ port: portName }),
          });
          const data = await resp.json();
          if (data.success) connected = true;
        } catch (e) {
          alert("è¿æ¥å¤±è´¥: " + e);
        }
        updateConnectionUI();
      }
      async function disconnect() {
        try {
          await fetch("/api/disconnect", { method: "POST" });
        } catch (e) {
          /* silent fail */
        }
        connected = false;
        updateConnectionUI();
      }
      async function sendJsonCommand(jsonObj) {
        if (!connected) {
          alert("è¯·å…ˆè¿æ¥ä¸²å£ï¼");
          return;
        }
        try {
          const resp = await fetch("/api/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jsonObj),
          });
          const data = await resp.json();
          if (!data.success) console.error("å‘é€å¤±è´¥: " + data.msg);
        } catch (e) {
          console.error("é€šä¿¡å¤±è´¥: " + e);
        }
      }
      const rgbToHex = (r, g, b) =>
        `#${[r, g, b]
          .map((c) => ("0" + Math.round(c).toString(16)).slice(-2))
          .join("")}`;
      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }
      const lerp = (a, b, f) => a + f * (b - a);
      function expandPalette(sourceColors, targetSize = 16) {
        if (!sourceColors || sourceColors.length === 0)
          return new Array(targetSize).fill("#000000");
        if (sourceColors.length === 1)
          return new Array(targetSize).fill(sourceColors[0]);
        const outputColors = [];
        for (let i = 0; i < targetSize; i++) {
          const p = (i / (targetSize - 1)) * (sourceColors.length - 1);
          const i1 = Math.floor(p),
            i2 = Math.min(i1 + 1, sourceColors.length - 1),
            f = p - i1;
          const c1 = hexToRgb(sourceColors[i1]),
            c2 = hexToRgb(sourceColors[i2]);
          if (c1 && c2)
            outputColors.push(
              rgbToHex(
                lerp(c1.r, c2.r, f),
                lerp(c1.g, c2.g, f),
                lerp(c1.b, c2.b, f)
              )
            );
        }
        return outputColors;
      }
      function parseColorString(str) {
        str = str.trim();
        if (str.startsWith("#")) {
          return /^#([a-f\d]{6})$/i.test(str) ? str : null;
        }
        const rgbParts = str.split(",").map((s) => parseInt(s, 10));
        if (
          rgbParts.length === 3 &&
          rgbParts.every((c) => !isNaN(c) && c >= 0 && c <= 255)
        ) {
          return rgbToHex(rgbParts[0], rgbParts[1], rgbParts[2]);
        }
        return null;
      }
      function updateCustomInputDisplay(colorsArray) {
        document.getElementById("customColorInput").value =
          colorsArray.join(", ");
      }
      function turnOff() {
        sendJsonCommand({ mode: "static", color: "#000000" });
        updateCustomInputDisplay(["#000000"]);
      }
      function setStaticPreset(hexColor) {
        sendJsonCommand({ mode: "static", color: hexColor });
        updateCustomInputDisplay([hexColor]);
      }
      function setGradientPreset(patternName) {
        const colors = gradientPresets[patternName];
        if (colors) {
          lastGradientColors = colors;
          updateCustomInputDisplay(colors);
          startGradient(colors);
        }
      }
      function startGradient(colors) {
        if (!colors || colors.length === 0) return;
        const speed = parseInt(document.getElementById("speedControl").value);
        const expandedColors = expandPalette(colors, 16);
        const speedMap = [200, 150, 120, 100, 80, 65, 55, 50, 30, 15];
        const mappedSpeed = speedMap[speed - 1] || 15;
        sendJsonCommand({
          mode: "gradient",
          colors: expandedColors,
          speed: mappedSpeed,
        });
      }
      function applyCustomInput() {
        const text = document.getElementById("customColorInput").value;
        const colorStrings = text
          .split(/[\n,]/)
          .map((s) => s.trim())
          .filter(Boolean);
        const validColors = colorStrings.map(parseColorString).filter(Boolean);
        if (validColors.length === 0) {
          alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„é¢œè‰²å€¼ï¼è¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚");
          return;
        }
        updateCustomInputDisplay(validColors);
        if (validColors.length === 1) {
          sendJsonCommand({ mode: "static", color: validColors[0] });
        } else {
          lastGradientColors = validColors;
          startGradient(validColors);
        }
      }
      async function applySchedule() {
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        if (!startTime || !endTime) {
          alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ã€‚");
          return;
        }
        try {
          const resp = await fetch("/api/schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start_time: startTime, end_time: endTime }),
          });
          const data = await resp.json();
          if (data.success) alert("å®šæ—¶è®¡åˆ’å·²æˆåŠŸåº”ç”¨ï¼");
        } catch (e) {
          alert("åº”ç”¨è®¡åˆ’å¤±è´¥: " + e);
        }
      }
      async function initializeApp() {
        try {
          const response = await fetch("/api/config");
          const config = await response.json();
          const portInput = document.getElementById("portInput");
          if (config.is_connected && config.connected_port) {
            connected = true;
            portInput.value = config.connected_port;
          } else {
            connected = false;
            if (config.default_com_port)
              portInput.value = config.default_com_port;
          }
          updateConnectionUI();
          if (config.last_light_state) {
            const state = config.last_light_state;
            if (state.mode === "static")
              updateCustomInputDisplay([state.color]);
            else if (state.mode === "gradient" && state.colors) {
              updateCustomInputDisplay(state.colors);
              lastGradientColors = state.colors;
            }
          }
          if (config.schedule) {
            document.getElementById("startTime").value =
              config.schedule.start_time || "00:00";
            document.getElementById("endTime").value =
              config.schedule.end_time || "08:00";
          }
        } catch (error) {
          console.error("æ— æ³•è·å–åç«¯é…ç½®:", error);
        }
        document
          .getElementById("speedControl")
          .addEventListener("input", function () {
            document.getElementById("speedValue").textContent = this.value;
            startGradient(lastGradientColors);
          });
      }
      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
